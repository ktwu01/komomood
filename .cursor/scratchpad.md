
# Komomood 应用重构计划

## 1. 背景与动机

原架构 (`前端 -> Google Sheet -> GitHub Action -> JSON 文件`) 脆弱且难以维护。为提升系统可靠性、可扩展性并实现数据自托管，我们将迁移至一个更健壮的架构：`前端 -> 本地后端 API -> 本地数据库`。

整个应用将部署在当前 Ubuntu 服务器上，并通过 `https://20011112.xyz/komomood/` 对外提供服务。

## 2. 关键挑战

- **后端开发**: 使用轻量级技术栈（如 Node.js + Express）创建一个简单、稳健的后端 API。
- **数据库设置**: 设计并初始化一个本地数据库（如 SQLite）来存储情绪数据。
- **数据迁移**: 将现有 `data/entries.json` 的数据安全、无损地迁移到新数据库。
- **前端重构**: 调整前端代码，使其与新的本地后端 API 进行通信。
- **Web 服务器配置**: 配置 Nginx 或其他 Web 服务器，使其能正确地：
  - 在 `/komomood/` 路径下提供前端静态文件。
  - 将 API 请求（如 `/api/*`）反向代理到后端服务。

## 3. 项目计划与状态看板

### 第一阶段：后端搭建与数据迁移

- [ ] **任务 1.1: 搭建基础后端服务**
  - **目标**: 选择并搭建一个基础的后端 API 服务器。
  - **技术选型**: Node.js + Express.js
  - **完成标准**: 后端服务能成功启动，并提供一个健康检查接口（如 `/api/health`），访问该接口返回成功状态。

- [ ] **任务 1.2: 集成 SQLite 数据库**
  - **目标**: 在后端项目中集成 SQLite 数据库。
  - **表结构 `mood_entries`**:
    - `id`: `INTEGER` (主键,自增)
    - `entry_date`: `TEXT` (唯一, 格式 'YYYY-MM-DD')
    - `koko_mood`: `INTEGER`
    - `momo_mood`: `INTEGER`
    - `komo_score`: `INTEGER`
    - `note`: `TEXT`
    - `created_at`: `TEXT` (默认 `CURRENT_TIMESTAMP`)
  - **完成标准**: 后端服务启动时能自动连接（或创建）数据库文件，并创建 `mood_entries` 表。

- [ ] **任务 1.3: 实现 CRUD API 接口**
  - **目标**: 创建用于管理情绪记录的增、删、改、查（CRUD）API 接口。
  - **核心接口**:
    - `GET /api/entries`: 获取所有情绪记录。
    - `POST /api/entries`: 新增一条情绪记录。
  - **完成标准**: 所有 API 接口功能正确，并通过工具（如 curl 或 Postman）测试。

- [ ] **任务 1.4: 迁移历史数据**
  - **目标**: 编写并执行一个一次性脚本，将 `data/entries.json` 的数据导入 SQLite 数据库。
  - **完成标准**: 数据库中的记录条数与 JSON 文件中的条目数完全一致。

### 第二阶段：前端改造与部署

- [ ] **任务 2.1: 重构前端数据逻辑**
  - **目标**: 修改前端 JavaScript (`app.js`)，使其通过新后端 API 存取数据。
  - **完成标准**: 页面能正确展示数据库中的所有记录，并能成功提交新记录。

- [ ] **任务 2.2: 配置 Web 服务器 (Nginx)**
  - **目标**: 配置 Nginx 实现应用的访问路由。
  - **配置要点**:
    - `location /komomood/`: 指向前端静态文件目录。
    - `location /api/`: 反向代理到后端 Node.js 服务的地址（如 `http://localhost:3000`）。
  - **完成标准**: 通过 `https://20011112.xyz/komomood/` 能成功访问应用，且所有功能正常。

- [ ] **任务 2.3: 配置后端服务持久化**
  - **目标**: 确保后端服务能在服务器重启后自动运行。
  - **推荐工具**: `pm2` 或 `systemd`。
  - **完成标准**: 后端服务被进程管理工具接管，并设置为开机自启。

## 4. 执行者反馈区

*此区域将在执行阶段更新，用于记录进展、问题或请求协助。*

## 5. 经验教训

### 问题 1: Node.js 服务器进程立即退出
**现象**: 无论是 Express 服务器还是原生 HTTP 服务器，Node.js 进程都会在启动后立即退出（Exit 1），导致无法访问 API 端点。

**尝试的解决方案**:
- 从 Express 5.x 降级到 Express 4.x
- 添加 process.stdin.resume() 保持进程活跃
- 使用原生 HTTP 模块替代 Express
- 添加错误处理和调试日志

**解决方案**: 发现问题是端口冲突 (EADDRINUSE)，端口 3000 已被占用。

### 问题 2: 重要环境注意事项
**关键教训**: 不要使用 `pkill -f node` 等命令杀死所有 Node.js 进程，因为 Cursor IDE 也依赖 Node.js，这可能会断开与服务器的连接。

**安全做法**: 只杀死特定的进程 ID，或使用不同的端口来避免冲突。